<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consensus Gallery | GenLayer Game</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary: { 300: '#a5b4fc', 400: '#818cf8', 500: '#667eea', 600: '#5a67d8' } } } }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); min-height: 100vh; font-family: 'Inter', sans-serif; }
    .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .gradient-text-gold { background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
    .btn-success { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
    .btn-warning { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse-dot { animation: pulse 2s ease-in-out infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .chat-scroll { max-height: 400px; overflow-y: auto; }
    .chat-scroll::-webkit-scrollbar { width: 6px; }
    .chat-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .chat-scroll::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.3); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    const CONTRACT = {
      ADDRESS: '0x5c2F525BA54839338F9BC9Cd8DF7B656FBc5E7d0',
      NETWORK: 'GenLayer Studio',
      CHAIN_ID: '0x' + (10242).toString(16),
      RPC_URL: 'https://rpc.asimov.genlayer.com',
      STUDIO_URL: 'https://studio.genlayer.com',
    };

    const CONFIG = {
      MAX_PLAYERS: 5,
      MIN_PLAYERS: 2,
      ENTRY_FEE: 0, // ÂÖçË¥πÊ∏∏Êàè
      WINNER_REWARD_PERCENT: 80,
      MIN_GAME_DURATION: 60,
      MAX_GAME_DURATION: 10 * 60,
      VOTE_DURATION: 30,
      WINNER_EXP: 100,
      CORRECT_VOTER_EXP: 30,
      PARTICIPANT_EXP: 10,
    };

    const STORAGE_KEY = 'consensus_gallery_v4';

    const ART_COLLECTION = [
      { id: 1, name: 'Starry Night', artist: 'Van Gogh', year: 1889, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/1280px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg' },
      { id: 2, name: 'Persistence of Memory', artist: 'Dali', year: 1931, url: 'https://upload.wikimedia.org/wikipedia/en/d/dd/The_Persistence_of_Memory.jpg' },
      { id: 3, name: 'The Great Wave', artist: 'Hokusai', year: 1831, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Tsunami_by_hokusai_19th_century.jpg/1280px-Tsunami_by_hokusai_19th_century.jpg' },
      { id: 4, name: 'Girl with Pearl Earring', artist: 'Vermeer', year: 1665, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/1665_Girl_with_a_Pearl_Earring.jpg/800px-1665_Girl_with_a_Pearl_Earring.jpg' },
      { id: 5, name: 'The Scream', artist: 'Munch', year: 1893, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Edvard_Munch%2C_1893%2C_The_Scream%2C_oil%2C_tempera_and_pastel_on_cardboard%2C_91_x_73_cm%2C_National_Gallery_of_Norway.jpg/800px-Edvard_Munch%2C_1893%2C_The_Scream%2C_oil%2C_tempera_and_pastel_on_cardboard%2C_91_x_73_cm%2C_National_Gallery_of_Norway.jpg' },
      { id: 6, name: 'Birth of Venus', artist: 'Botticelli', year: 1485, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Sandro_Botticelli_-_La_nascita_di_Venere_-_Google_Art_Project_-_edited.jpg/1280px-Sandro_Botticelli_-_La_nascita_di_Venere_-_Google_Art_Project_-_edited.jpg' },
      { id: 7, name: 'American Gothic', artist: 'Wood', year: 1930, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Grant_Wood_-_American_Gothic_-_Google_Art_Project.jpg/800px-Grant_Wood_-_American_Gothic_-_Google_Art_Project.jpg' },
      { id: 8, name: 'The Kiss', artist: 'Klimt', year: 1908, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/40/The_Kiss_-_Gustav_Klimt_-_Google_Cultural_Institute.jpg/800px-The_Kiss_-_Gustav_Klimt_-_Google_Cultural_Institute.jpg' },
      { id: 9, name: 'Cafe Terrace', artist: 'Van Gogh', year: 1888, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg/800px-Van_Gogh_-_Terrasse_des_Caf%C3%A9s_an_der_Place_du_Forum_in_Arles_am_Abend1.jpeg' },
      { id: 10, name: 'Water Lilies', artist: 'Monet', year: 1906, url: 'https://upload.wikimedia.org/wikipedia/commons/a/aa/Claude_Monet_-_Water_Lilies_-_1906%2C_Ryerson.jpg' },
      { id: 11, name: 'Whistlers Mother', artist: 'Whistler', year: 1871, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Whistlers_Mother_high_res.jpg/1280px-Whistlers_Mother_high_res.jpg' },
      { id: 12, name: 'La Grande Jatte', artist: 'Seurat', year: 1886, url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7d/A_Sunday_on_La_Grande_Jatte%2C_Georges_Seurat%2C_1884.jpg/1280px-A_Sunday_on_La_Grande_Jatte%2C_Georges_Seurat%2C_1884.jpg' },
    ];

    const ADJECTIVES = ['Swift', 'Brave', 'Wise', 'Noble', 'Silent', 'Golden', 'Silver', 'Cosmic', 'Mystic', 'Ancient'];
    const NOUNS = ['Phoenix', 'Dragon', 'Tiger', 'Eagle', 'Wolf', 'Hawk', 'Lion', 'Bear', 'Serpent', 'Falcon'];

    const generatePlayerId = (address) => {
      const hash = address.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
      return `${ADJECTIVES[hash % ADJECTIVES.length]}${NOUNS[(hash * 7) % NOUNS.length]}${(hash % 99) + 1}`;
    };

    const shortenAddress = (addr) => addr ? `${addr.slice(0, 6)}...${addr.slice(-4)}` : '';
    const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
    const formatGEN = (amount) => amount.toFixed(4);
    const getArt = (id) => ART_COLLECTION.find(a => a.id === id) || ART_COLLECTION[0];
    const getRandomArt = () => ART_COLLECTION[Math.floor(Math.random() * ART_COLLECTION.length)];

    const getStorage = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; } };
    const setStorage = (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {} };
    const createInitialState = () => ({ rooms: {}, leaderboard: {}, totalGames: 0, playerIds: {} });

    const phaseLabels = { waiting: 'Waiting', playing: 'Playing', voting: 'Voting', finished: 'Finished' };
    const phaseColors = { waiting: '#6B7280', playing: '#10B981', voting: '#F59E0B', finished: '#8B5CF6' };

    const Spinner = () => <div className="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>;

    const ArtDisplay = ({ artId, size = 280 }) => {
      const art = getArt(artId);
      const [loaded, setLoaded] = useState(false);
      return (
        <div className="relative flex-shrink-0" style={{ width: size, height: size }}>
          {!loaded && <div className="absolute inset-0 bg-white/5 rounded-xl animate-pulse flex items-center justify-center"><Spinner /></div>}
          <img src={art.url} alt={art.name} onLoad={() => setLoaded(true)} className={`w-full h-full object-cover rounded-xl shadow-2xl ${loaded ? 'opacity-100' : 'opacity-0'}`} />
        </div>
      );
    };

    function App() {
      const [wallet, setWallet] = useState({ connected: false, address: null, balance: 0 });
      const [globalState, setGlobalState] = useState(createInitialState);
      const [activeTab, setActiveTab] = useState('rooms');
      const [currentRoomId, setCurrentRoomId] = useState(null);
      const [message, setMessage] = useState('');
      const [connecting, setConnecting] = useState(false);
      const chatEndRef = useRef(null);

      useEffect(() => {
        const saved = getStorage();
        if (saved) setGlobalState(saved);
      }, []);

      useEffect(() => {
        setStorage(globalState);
      }, [globalState]);

      useEffect(() => {
        if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
      }, [globalState.rooms[currentRoomId]?.messages]);

      useEffect(() => {
        const interval = setInterval(() => {
          setGlobalState(prev => {
            let updated = { ...prev, rooms: { ...prev.rooms } };
            Object.keys(updated.rooms).forEach(roomId => {
              const room = updated.rooms[roomId];
              if (room.phase === 'playing' && Date.now() >= room.gameEndTime) {
                updated.rooms[roomId] = { ...room, phase: 'voting', votingEndTime: Date.now() + CONFIG.VOTE_DURATION * 1000 };
              } else if (room.phase === 'voting' && Date.now() >= room.votingEndTime) {
                const voteCount = {};
                Object.values(room.votes || {}).forEach(addr => voteCount[addr] = (voteCount[addr] || 0) + 1);
                const winner = Object.entries(voteCount).sort((a, b) => b[1] - a[1])[0]?.[0];
                const totalPot = room.players.length * CONFIG.ENTRY_FEE;
                const reward = totalPot * CONFIG.WINNER_REWARD_PERCENT / 100;
                updated.rooms[roomId] = { ...room, phase: 'finished', winner, voteCount, finishTime: Date.now(), reward };
                if (winner && !updated.leaderboard[winner]) updated.leaderboard[winner] = { address: winner, wins: 0, experience: 0, playerId: prev.playerIds[winner] || generatePlayerId(winner) };
                room.players.forEach(addr => {
                  if (!updated.leaderboard[addr]) updated.leaderboard[addr] = { address: addr, wins: 0, experience: 0, playerId: prev.playerIds[addr] || generatePlayerId(addr) };
                  if (addr === winner) {
                    updated.leaderboard[addr].wins++;
                    updated.leaderboard[addr].experience += CONFIG.WINNER_EXP;
                  } else if (room.votes?.[addr] === winner) {
                    updated.leaderboard[addr].experience += CONFIG.CORRECT_VOTER_EXP;
                  } else {
                    updated.leaderboard[addr].experience += CONFIG.PARTICIPANT_EXP;
                  }
                });
                updated.totalGames++;
              }
            });
            return updated;
          });
        }, 1000);
        return () => clearInterval(interval);
      }, []);

      const handleConnectWallet = async () => {
        setConnecting(true);
        try {
          if (!window.ethereum) {
            alert('Please install MetaMask to play!');
            setConnecting(false);
            return;
          }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const address = accounts[0];
          
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (chainId !== CONTRACT.CHAIN_ID) {
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: CONTRACT.CHAIN_ID }],
              });
            } catch (switchError) {
              if (switchError.code === 4902) {
                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: CONTRACT.CHAIN_ID,
                    chainName: CONTRACT.NETWORK,
                    rpcUrls: [CONTRACT.RPC_URL],
                    nativeCurrency: { name: 'GEN', symbol: 'GEN', decimals: 18 },
                    blockExplorerUrls: [CONTRACT.STUDIO_URL],
                  }],
                });
              }
            }
          }
          
          const balance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [address, 'latest'],
          });
          const balanceInGEN = parseInt(balance, 16) / 1e18;
          
          setWallet({ connected: true, address, balance: balanceInGEN });
          
          if (!globalState.playerIds[address]) {
            setGlobalState(prev => ({
              ...prev,
              playerIds: { ...prev.playerIds, [address]: generatePlayerId(address) },
            }));
          }
        } catch (err) {
          console.error('Wallet connection failed:', err);
          alert('Failed to connect wallet: ' + err.message);
        }
        setConnecting(false);
      };

      const handleCreateRoom = () => {
        const roomId = `room_${Date.now()}`;
        const room = {
          id: roomId,
          host: wallet.address,
          players: [wallet.address],
          phase: 'waiting',
          artId: getRandomArt().id,
          messages: [],
          votes: {},
          createdAt: Date.now(),
        };
        setGlobalState(prev => ({ ...prev, rooms: { ...prev.rooms, [roomId]: room } }));
        setCurrentRoomId(roomId);
        setActiveTab('game');
      };

      const handleJoinRoom = (roomId) => {
        const room = globalState.rooms[roomId];
        if (!room || room.players.includes(wallet.address) || room.phase !== 'waiting' || room.players.length >= CONFIG.MAX_PLAYERS) return;
        
        setGlobalState(prev => ({
          ...prev,
          rooms: {
            ...prev.rooms,
            [roomId]: { ...room, players: [...room.players, wallet.address] },
          },
        }));
        setCurrentRoomId(roomId);
        setActiveTab('game');
      };

      const handleStartGame = () => {
        const room = globalState.rooms[currentRoomId];
        if (!room || room.host !== wallet.address || room.players.length < CONFIG.MIN_PLAYERS) return;
        setGlobalState(prev => ({
          ...prev,
          rooms: {
            ...prev.rooms,
            [currentRoomId]: { ...room, phase: 'playing', gameEndTime: Date.now() + CONFIG.MIN_GAME_DURATION * 1000 },
          },
        }));
      };

      const handleLeaveRoom = () => {
        const room = globalState.rooms[currentRoomId];
        if (!room || room.phase !== 'waiting') return;
        const newPlayers = room.players.filter(p => p !== wallet.address);
        if (newPlayers.length === 0) {
          const { [currentRoomId]: _, ...rest } = globalState.rooms;
          setGlobalState(prev => ({ ...prev, rooms: rest }));
        } else {
          setGlobalState(prev => ({
            ...prev,
            rooms: {
              ...prev.rooms,
              [currentRoomId]: { ...room, players: newPlayers, host: newPlayers[0] },
            },
          }));
        }
        setCurrentRoomId(null);
        setActiveTab('rooms');
      };

      const handleSendMessage = () => {
        if (!message.trim()) return;
        const room = globalState.rooms[currentRoomId];
        if (!room || room.phase !== 'playing') return;
        const msg = { id: Date.now(), author: wallet.address, content: message.trim(), timestamp: Date.now() };
        setGlobalState(prev => ({
          ...prev,
          rooms: {
            ...prev.rooms,
            [currentRoomId]: { ...room, messages: [...(room.messages || []), msg] },
          },
        }));
        setMessage('');
      };

      const handleVote = (addr) => {
        const room = globalState.rooms[currentRoomId];
        if (!room || room.phase !== 'voting' || room.votes?.[wallet.address]) return;
        setGlobalState(prev => ({
          ...prev,
          rooms: {
            ...prev.rooms,
            [currentRoomId]: { ...room, votes: { ...room.votes, [wallet.address]: addr } },
          },
        }));
      };

      const currentRoom = currentRoomId ? globalState.rooms[currentRoomId] : null;
      const sortedLeaderboard = useMemo(() => Object.values(globalState.leaderboard).sort((a, b) => b.experience - a.experience || b.wins - a.wins), [globalState.leaderboard]);
      const playerRank = useMemo(() => sortedLeaderboard.findIndex(p => p.address === wallet.address) + 1, [sortedLeaderboard, wallet.address]);

      return (
        <div className="min-h-screen text-white p-4 max-w-7xl mx-auto">
          <header className="flex items-center justify-between mb-6 pb-4 border-b border-white/10">
            <div>
              <h1 className="text-3xl font-bold gradient-text">üé® Consensus Gallery</h1>
              <p className="text-sm text-gray-400 mt-1">Describe art, vote, and win on {CONTRACT.NETWORK}</p>
            </div>
            {!wallet.connected ? (
              <button onClick={handleConnectWallet} disabled={connecting} className="btn-primary text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition flex items-center gap-2">
                {connecting ? <><Spinner /> Connecting...</> : <>üîó Connect Wallet</>}
              </button>
            ) : (
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <div className="text-sm text-gray-400">Balance</div>
                  <div className="font-bold text-primary-300">{formatGEN(wallet.balance)} GEN</div>
                </div>
                <div className="glass rounded-xl px-4 py-2">
                  <div className="text-xs text-gray-400">Player</div>
                  <div className="font-semibold">{globalState.playerIds[wallet.address] || generatePlayerId(wallet.address)}</div>
                  <div className="text-xs text-gray-500">{shortenAddress(wallet.address)}</div>
                </div>
                {playerRank > 0 && (
                  <div className="glass rounded-xl px-4 py-2 text-center">
                    <div className="text-xs text-gray-400">Rank</div>
                    <div className="text-xl font-bold text-yellow-500">#{playerRank}</div>
                  </div>
                )}
              </div>
            )}
          </header>

          {!wallet.connected ? (
            <div className="glass rounded-2xl p-12 text-center animate-fade-in">
              <div className="text-6xl mb-6">üé®</div>
              <h2 className="text-3xl font-bold gradient-text mb-4">Welcome to Consensus Gallery</h2>
              <p className="text-gray-400 mb-6 max-w-2xl mx-auto">
                A social art game on GenLayer where you describe famous artworks, vote for the best descriptions, and earn rewards through community consensus!
              </p>
              <div className="grid md:grid-cols-3 gap-4 mb-8">
                <div className="glass rounded-xl p-4">
                  <div className="text-2xl mb-2">üñºÔ∏è</div>
                  <h3 className="font-semibold mb-1">View Art</h3>
                  <p className="text-sm text-gray-400">See masterpieces from history</p>
                </div>
                <div className="glass rounded-xl p-4">
                  <div className="text-2xl mb-2">‚úçÔ∏è</div>
                  <h3 className="font-semibold mb-1">Describe</h3>
                  <p className="text-sm text-gray-400">Share your interpretation</p>
                </div>
                <div className="glass rounded-xl p-4">
                  <div className="text-2xl mb-2">üó≥Ô∏è</div>
                  <h3 className="font-semibold mb-1">Vote & Win</h3>
                  <p className="text-sm text-gray-400">Best description wins!</p>
                </div>
              </div>
              <div className="glass rounded-xl p-4 mb-6 bg-green-500/10 border-green-500/20">
                <p className="text-green-400 font-semibold">‚ú® FREE TO PLAY - No GEN tokens required!</p>
                <p className="text-sm text-gray-400 mt-1">Connect your wallet to start playing immediately</p>
              </div>
              <button onClick={handleConnectWallet} disabled={connecting} className="btn-primary text-white px-8 py-4 rounded-xl font-semibold text-lg hover:opacity-90 transition inline-flex items-center gap-2">
                {connecting ? <><Spinner /> Connecting...</> : <>üîó Connect Wallet to Play</>}
              </button>
            </div>
          ) : (
            <div>
              <nav className="flex gap-2 mb-6">
                {['rooms', 'game', 'leaderboard'].map(tab => (
                  <button key={tab} onClick={() => setActiveTab(tab)} className={`px-6 py-3 rounded-xl font-medium transition ${activeTab === tab ? 'btn-primary text-white' : 'glass text-gray-400 hover:text-white'}`}>
                    {tab === 'rooms' && 'üè† Rooms'}
                    {tab === 'game' && 'üéÆ Game'}
                    {tab === 'leaderboard' && 'üèÜ Leaderboard'}
                  </button>
                ))}
              </nav>

              <main>
                {activeTab === 'rooms' && (
                  <div className="animate-fade-in">
                    <div className="glass rounded-2xl p-6 mb-6">
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="text-2xl font-bold">Game Rooms</h2>
                        <button onClick={handleCreateRoom} className="btn-success text-white px-6 py-2 rounded-lg font-medium hover:opacity-90">+ Create Room</button>
                      </div>
                      <div className="grid gap-4">
                        {Object.values(globalState.rooms).filter(r => r.phase === 'waiting').length === 0 ? (
                          <div className="text-center py-10 text-gray-500">No active rooms. Create one to start!</div>
                        ) : (
                          Object.values(globalState.rooms).filter(r => r.phase === 'waiting').map(room => (
                            <div key={room.id} className="glass rounded-xl p-4 flex items-center justify-between hover:bg-white/5 transition">
                              <div className="flex items-center gap-4">
                                <ArtDisplay artId={room.artId} size={80} />
                                <div>
                                  <div className="font-semibold">Room by {globalState.playerIds[room.host] || generatePlayerId(room.host)}</div>
                                  <div className="text-sm text-gray-400">Players: {room.players.length}/{CONFIG.MAX_PLAYERS}</div>
                                  <div className="text-xs text-gray-500">{getArt(room.artId).name} ‚Ä¢ {getArt(room.artId).artist}</div>
                                </div>
                              </div>
                              <button onClick={() => handleJoinRoom(room.id)} disabled={room.players.length >= CONFIG.MAX_PLAYERS || room.players.includes(wallet.address)}
                                className={`px-6 py-2 rounded-lg font-medium ${room.players.length >= CONFIG.MAX_PLAYERS || room.players.includes(wallet.address) ? 'bg-white/10 text-gray-500' : 'btn-primary text-white hover:opacity-90'}`}>
                                {room.players.includes(wallet.address) ? 'Joined' : room.players.length >= CONFIG.MAX_PLAYERS ? 'Full' : 'Join (FREE)'}
                              </button>
                            </div>
                          ))
                        )}
                      </div>
                    </div>

                    <div className="glass rounded-2xl p-6">
                      <h2 className="text-xl font-bold mb-4">Active Games</h2>
                      <div className="space-y-3">
                        {Object.values(globalState.rooms).filter(r => r.phase !== 'waiting' && r.players.includes(wallet.address)).length === 0 ? (
                          <div className="text-center py-6 text-gray-500">You're not in any active games</div>
                        ) : (
                          Object.values(globalState.rooms).filter(r => r.phase !== 'waiting' && r.players.includes(wallet.address)).map(room => (
                            <button key={room.id} onClick={() => { setCurrentRoomId(room.id); setActiveTab('game'); }} className="w-full glass rounded-lg p-4 flex items-center justify-between hover:bg-white/5 transition">
                              <div className="flex items-center gap-3">
                                <div className="w-3 h-3 rounded-full pulse-dot" style={{ backgroundColor: phaseColors[room.phase] }}></div>
                                <div className="text-left">
                                  <div className="font-medium">{getArt(room.artId).name}</div>
                                  <div className="text-sm text-gray-400">{phaseLabels[room.phase]} ‚Ä¢ {room.players.length} players</div>
                                </div>
                              </div>
                              <div className="text-sm text-gray-500">‚Üí</div>
                            </button>
                          ))
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'game' && (
                  <div className="animate-fade-in">
                    {!currentRoom ? (
                      <div className="glass rounded-2xl p-12 text-center">
                        <div className="text-6xl mb-4">üéÆ</div>
                        <h2 className="text-2xl font-bold mb-2">No Active Game</h2>
                        <p className="text-gray-400 mb-6">Create or join a room to start playing!</p>
                        <button onClick={() => setActiveTab('rooms')} className="btn-primary text-white px-6 py-3 rounded-lg font-medium">Go to Rooms</button>
                      </div>
                    ) : (
                      <div className="grid lg:grid-cols-2 gap-6">
                        <div className="space-y-4">
                          <div className="glass rounded-xl p-5">
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="font-semibold">Game Status</h3>
                              <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full pulse-dot" style={{ backgroundColor: phaseColors[currentRoom.phase] }}></div>
                                <span className="text-sm" style={{ color: phaseColors[currentRoom.phase] }}>{phaseLabels[currentRoom.phase]}</span>
                              </div>
                            </div>

                            {currentRoom.phase === 'playing' && (
                              <div className="text-center py-2">
                                <div className="text-3xl font-bold text-primary-300">{formatTime(Math.max(0, Math.floor((currentRoom.gameEndTime - Date.now()) / 1000)))}</div>
                                <div className="text-sm text-gray-400">Time Remaining</div>
                              </div>
                            )}

                            {currentRoom.phase === 'voting' && (
                              <div className="text-center py-2">
                                <div className="text-3xl font-bold text-yellow-500">{formatTime(Math.max(0, Math.floor((currentRoom.votingEndTime - Date.now()) / 1000)))}</div>
                                <div className="text-sm text-gray-400">Voting Time</div>
                              </div>
                            )}

                            {currentRoom.phase === 'finished' && (
                              <div className="text-center py-4">
                                <div className="text-5xl mb-2">üèÜ</div>
                                <div className="font-bold text-xl text-yellow-500 mb-2">Winner: {globalState.playerIds[currentRoom.winner] || generatePlayerId(currentRoom.winner)}</div>
                                {currentRoom.winner === wallet.address && (
                                  <div className="text-green-400 font-semibold">üéâ You won {CONFIG.WINNER_EXP} XP!</div>
                                )}
                              </div>
                            )}
                          </div>

                          <div className="glass rounded-xl p-5">
                            <h3 className="font-semibold mb-4">üé® Artwork</h3>
                            <div className="flex flex-col items-center gap-4">
                              <ArtDisplay artId={currentRoom.artId} size={280} />
                              <div className="text-center">
                                <h4 className="text-lg font-semibold">{getArt(currentRoom.artId).name}</h4>
                                <p className="text-sm text-gray-400">{getArt(currentRoom.artId).artist} ‚Ä¢ {getArt(currentRoom.artId).year}</p>
                              </div>
                            </div>
                          </div>

                          <div className="glass rounded-xl p-5">
                            <h3 className="font-semibold mb-3">üë• Players ({currentRoom.players.length})</h3>
                            <div className="space-y-2">
                              {currentRoom.players.map(addr => (
                                <div key={addr} className={`p-2 rounded-lg ${addr === wallet.address ? 'bg-primary-500/10' : 'bg-white/5'}`}>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm font-medium">{globalState.playerIds[addr] || generatePlayerId(addr)}{addr === wallet.address && ' (You)'}</span>
                                    {addr === currentRoom.host && <span className="text-xs bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded">Host</span>}
                                  </div>
                                </div>
                              ))}
                            </div>

                            {currentRoom.phase === 'waiting' && currentRoom.host === wallet.address && (
                              <button onClick={handleStartGame} disabled={currentRoom.players.length < CONFIG.MIN_PLAYERS}
                                className={`w-full mt-4 py-3 rounded-lg font-semibold ${currentRoom.players.length >= CONFIG.MIN_PLAYERS ? 'btn-success text-white' : 'bg-white/10 text-gray-500'}`}>
                                {currentRoom.players.length >= CONFIG.MIN_PLAYERS ? 'Start Game' : `Need ${CONFIG.MIN_PLAYERS - currentRoom.players.length} more player(s)`}
                              </button>
                            )}

                            {currentRoom.phase !== 'finished' && <button onClick={handleLeaveRoom} className="w-full py-2 text-sm text-gray-500 hover:text-gray-300">Leave Room</button>}
                          </div>
                        </div>

                        <div className="space-y-4">
                          {currentRoom.phase === 'playing' && (
                            <div className="glass rounded-xl p-5">
                              <h3 className="font-semibold mb-3">üí¨ Describe the Art</h3>
                              <div className="chat-scroll mb-4 space-y-2 p-2 bg-black/20 rounded-lg min-h-[200px]">
                                {currentRoom.messages?.length === 0 ? (
                                  <div className="text-center py-8 text-gray-500 text-sm">Start describing!</div>
                                ) : currentRoom.messages?.map(msg => (
                                  <div key={msg.id} className={`p-3 rounded-lg ${msg.author === wallet.address ? 'bg-primary-500/20 ml-8' : 'bg-white/5 mr-8'}`}>
                                    <div className="flex justify-between items-start mb-1">
                                      <span className="text-xs font-medium text-gray-400">{globalState.playerIds[msg.author] || generatePlayerId(msg.author)}</span>
                                      <span className="text-xs text-gray-500">{new Date(msg.timestamp).toLocaleTimeString()}</span>
                                    </div>
                                    <p className="text-gray-200">{msg.content}</p>
                                  </div>
                                ))}
                                <div ref={chatEndRef} />
                              </div>
                              <div className="flex gap-2">
                                <input type="text" value={message} onChange={e => setMessage(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSendMessage()}
                                  placeholder="Describe the art..." className="flex-1 px-4 py-2 rounded-lg bg-black/30 border border-white/10 text-gray-200 focus:outline-none focus:border-primary-500/50" />
                                <button onClick={handleSendMessage} disabled={!message.trim()} className={`px-4 py-2 rounded-lg font-medium ${message.trim() ? 'btn-success text-white' : 'bg-white/10 text-gray-500'}`}>Send</button>
                              </div>
                            </div>
                          )}

                          {currentRoom.phase === 'voting' && (
                            <div className="glass rounded-xl p-5">
                              <h3 className="font-semibold mb-4">üó≥Ô∏è Vote for Best Description</h3>
                              <div className="space-y-3">
                                {[...new Set(currentRoom.messages?.map(m => m.author) || [])].map(addr => {
                                  const authorMsgs = currentRoom.messages?.filter(m => m.author === addr) || [];
                                  const isVoted = currentRoom.votes?.[wallet.address] === addr;
                                  const voteCount = Object.values(currentRoom.votes || {}).filter(v => v === addr).length;
                                  return (
                                    <div key={addr} onClick={() => !currentRoom.votes?.[wallet.address] && handleVote(addr)}
                                      className={`p-4 rounded-lg transition ${isVoted ? 'bg-primary-500/20 border border-primary-500/40' : 'bg-white/5 border border-white/5'} ${!currentRoom.votes?.[wallet.address] ? 'cursor-pointer hover:bg-white/10' : ''}`}>
                                      <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-medium">{globalState.playerIds[addr] || generatePlayerId(addr)}{addr === wallet.address ? ' (You)' : ''}</span>
                                        <span className="text-yellow-500 text-sm">üó≥Ô∏è {voteCount}</span>
                                      </div>
                                      <div className="space-y-1">{authorMsgs.slice(0, 2).map((m, i) => <p key={i} className="text-sm text-gray-300 truncate">"{m.content}"</p>)}</div>
                                      {isVoted && <div className="mt-2 text-sm text-primary-400">‚úì Your vote</div>}
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}

                          {currentRoom.phase === 'finished' && (
                            <div className="glass rounded-xl p-5">
                              <h3 className="font-semibold mb-4">üìä Final Results</h3>
                              <div className="space-y-2">
                                {[...new Set(currentRoom.messages?.map(m => m.author) || [])].sort((a, b) => (currentRoom.voteCount?.[b] || 0) - (currentRoom.voteCount?.[a] || 0)).map(addr => (
                                  <div key={addr} className={`p-3 rounded-lg ${addr === currentRoom.winner ? 'bg-yellow-500/20' : 'bg-white/5'}`}>
                                    <div className="flex justify-between">
                                      <span>{addr === currentRoom.winner && 'üèÜ '}{globalState.playerIds[addr] || generatePlayerId(addr)}</span>
                                      <span className="text-yellow-500">{currentRoom.voteCount?.[addr] || 0} votes</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'leaderboard' && (
                  <div className="glass rounded-2xl p-6 animate-fade-in">
                    <h2 className="text-2xl font-bold text-center gradient-text-gold mb-6">üèÜ Leaderboard</h2>
                    {sortedLeaderboard.length === 0 ? (
                      <div className="text-center py-10 text-gray-500">No players yet</div>
                    ) : (
                      <div className="space-y-2">
                        {sortedLeaderboard.map((p, idx) => (
                          <div key={p.address} className={`grid grid-cols-[50px_1fr_70px_60px] items-center p-3 rounded-lg ${idx === 0 ? 'bg-yellow-500/10' : p.address === wallet.address ? 'bg-primary-500/10' : 'bg-white/3'}`}>
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${idx < 3 ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-white/10'}`}>
                              {idx < 3 ? ['ü•á', 'ü•à', 'ü•â'][idx] : idx + 1}
                            </div>
                            <span className="text-sm font-medium truncate">{p.playerId}{p.address === wallet.address && ' (You)'}</span>
                            <div className="text-center"><div className="font-bold text-primary-300">{p.experience}</div><div className="text-[10px] text-gray-500">XP</div></div>
                            <div className="text-center"><div className="font-bold text-green-400">{p.wins}</div><div className="text-[10px] text-gray-500">Wins</div></div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </main>

              <footer className="text-center py-6 border-t border-white/5 mt-8">
                <p className="text-sm text-gray-500">Consensus Gallery ‚Ä¢ Powered by <a href={CONTRACT.STUDIO_URL} target="_blank" className="text-primary-400 hover:underline">GenLayer Studio</a></p>
              </footer>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
