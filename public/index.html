<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consensus Gallery | GenLayer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); min-height: 100vh; font-family: 'Inter', sans-serif; }
    .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-success { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ========== CONFIG ==========
    // üëáüëáüëá ÈÉ®ÁΩ≤ÂêàÁ∫¶ÂêéÂú®ËøôÈáåÊõ¥Êñ∞Âú∞ÂùÄ üëáüëáüëá
    const CONTRACT_ADDRESS = '0x93b8A5b05516ECb9E6a6F10d0b80fe913Aff99BE';
    const RPC_URL = 'https://rpc.studio.genlayer.com';
    const AI_TIMEOUT = 30000; // 30 seconds before AI joins
    // =============================

    const ART = [
      { id: 1, name: 'Starry Night', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/400px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg' },
      { id: 2, name: 'The Scream', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Edvard_Munch%2C_1893%2C_The_Scream%2C_oil%2C_tempera_and_pastel_on_cardboard%2C_91_x_73_cm%2C_National_Gallery_of_Norway.jpg/400px-Edvard_Munch%2C_1893%2C_The_Scream%2C_oil%2C_tempera_and_pastel_on_cardboard%2C_91_x_73_cm%2C_National_Gallery_of_Norway.jpg' },
      { id: 3, name: 'Great Wave', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Tsunami_by_hokusai_19th_century.jpg/400px-Tsunami_by_hokusai_19th_century.jpg' },
      { id: 4, name: 'Girl Pearl', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/1665_Girl_with_a_Pearl_Earring.jpg/400px-1665_Girl_with_a_Pearl_Earring.jpg' },
      { id: 5, name: 'Mona Lisa', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg/400px-Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg' },
      { id: 6, name: 'The Persistence of Memory', url: 'https://upload.wikimedia.org/wikipedia/en/d/dd/The_Persistence_of_Memory.jpg' },
      { id: 7, name: 'The Birth of Venus', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Sandro_Botticelli_-_La_nascita_di_Venere_-_Google_Art_Project_-_edited.jpg/400px-Sandro_Botticelli_-_La_nascita_di_Venere_-_Google_Art_Project_-_edited.jpg' },
      { id: 8, name: 'The Last Supper', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/48/The_Last_Supper_-_Leonardo_Da_Vinci_-_High_Resolution_32x16.jpg/400px-The_Last_Supper_-_Leonardo_Da_Vinci_-_High_Resolution_32x16.jpg' },
    ];

    // AI descriptions for each artwork
    const AI_DESCRIPTIONS = {
      1: ["The swirling night sky creates a sense of cosmic energy and movement", "Deep blues and bright yellows dance together in this dreamlike nocturne", "A village sleeps peacefully under the turbulent yet beautiful sky"],
      2: ["An expression of existential anxiety captured in bold, wavy lines", "The figure seems overwhelmed by the blood-red sky behind them", "Nature itself appears to be screaming alongside the central figure"],
      3: ["A massive wave threatens tiny boats with its powerful curl", "The foam creates intricate patterns like claws reaching for Mount Fuji", "Nature's raw power contrasted with distant serenity of the mountain"],
      4: ["Her enigmatic gaze follows you with quiet intensity", "The luminous pearl catches light against the dark background", "Simple composition yet deeply captivating in its intimacy"],
      5: ["That mysterious smile has puzzled viewers for centuries", "Soft sfumato technique creates an ethereal, dreamlike quality", "The landscape behind her seems to exist in a different realm"],
      6: ["Melting clocks suggest the fluid nature of time itself", "A surreal dreamscape where nothing is quite as it seems", "Time becomes meaningless in this barren yet fascinating world"],
      7: ["Beauty emerges from the sea foam on a giant shell", "Graceful figures and flowing fabric create a sense of divine birth", "Renaissance ideals of beauty captured in mythological form"],
      8: ["Twelve disciples react differently to Jesus's revelation", "Geometric perspective draws us into this pivotal moment", "Each face tells a different story of shock, denial, or sorrow"],
    };

    const getArt = (id) => ART.find(a => a.id === parseInt(id)) || ART[0];
    const shortAddr = (a) => {
      if (!a) return '';
      if (a.startsWith('AI_')) return 'ü§ñ AI Player';
      return `${a.slice(0,6)}...${a.slice(-4)}`;
    };
    const isAI = (addr) => addr && addr.startsWith('AI_');

    // Get random AI description for artwork
    const getAIDescription = (artId) => {
      const descs = AI_DESCRIPTIONS[artId] || AI_DESCRIPTIONS[1];
      return descs[Math.floor(Math.random() * descs.length)];
    };

    // RPC helper
    let rpcId = 0;
    const rpc = async (method, params = []) => {
      const res = await fetch(RPC_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: ++rpcId, method, params })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      return data.result;
    };

    // Contract read
    const readContract = async (fn, args = []) => {
      return rpc('gen_call', [{ to: CONTRACT_ADDRESS, data: { function: fn, args } }]);
    };

    // Contract write (via MetaMask)
    const writeContract = async (from, fn, args = []) => {
      if (!window.ethereum) throw new Error('No MetaMask');
      const callData = JSON.stringify({ function: fn, args });
      return window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{ from, to: CONTRACT_ADDRESS, data: '0x' + [...callData].map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('') }]
      });
    };

    const Spinner = () => <div className="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>;

    function App() {
      const [wallet, setWallet] = useState({ connected: false, address: '' });
      const [tab, setTab] = useState('lobby');
      const [roomId, setRoomId] = useState('');
      const [room, setRoom] = useState(null);
      const [players, setPlayers] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [joinInput, setJoinInput] = useState('');
      const [waitingRooms, setWaitingRooms] = useState([]);
      const [roomCreateTime, setRoomCreateTime] = useState(null);
      const [aiAdded, setAiAdded] = useState(false);
      const [aiTimeout, setAiTimeout] = useState(null);
      const [hasAISentMessage, setHasAISentMessage] = useState(false);
      const [hasAIVoted, setHasAIVoted] = useState(false);

      // Connect wallet
      const connect = async () => {
        if (!window.ethereum) { setError('Install MetaMask!'); return; }
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (accounts[0]) {
            setWallet({ connected: true, address: accounts[0] });
            setSuccess('Connected!');
          }
        } catch (e) { setError(e.message); }
      };

      // Auto connect
      useEffect(() => {
        if (window.ethereum) {
          window.ethereum.request({ method: 'eth_accounts' }).then(accs => {
            if (accs[0]) setWallet({ connected: true, address: accs[0] });
          });
        }
      }, []);

      // Poll waiting rooms list
      useEffect(() => {
        const pollRooms = async () => {
          try {
            const data = await readContract('get_waiting_rooms', []);
            if (data) {
              const rooms = data.split(';;').filter(Boolean).map(r => {
                const [rid, creator, artId, createTime, pcount] = r.split(':');
                return { rid, creator, artId, createTime: parseInt(createTime), playerCount: parseInt(pcount) };
              });
              setWaitingRooms(rooms);
            }
          } catch (e) { console.error('Failed to fetch rooms:', e); }
        };
        pollRooms();
        const interval = setInterval(pollRooms, 5000);
        return () => clearInterval(interval);
      }, []);

      // Poll room data
      useEffect(() => {
        if (!roomId) return;
        const poll = async () => {
          try {
            const data = await readContract('get_room', [roomId]);
            if (data) {
              const [phase, creator, artId, createTime, winner] = data.split(',');
              setRoom({ phase: parseInt(phase), creator, artId, createTime: parseInt(createTime), winner });
              if (!roomCreateTime && createTime) {
                setRoomCreateTime(parseInt(createTime) * 1000);
              }
            }
            const pdata = await readContract('get_players', [roomId]);
            if (pdata) {
              setPlayers(pdata.split(',').filter(Boolean));
            }
            const msgs = await readContract('get_messages', [roomId]);
            if (msgs) {
              setMessages(msgs.split(';;').filter(Boolean).map(m => {
                const [author, content, time] = m.split('|');
                return { author, content, time };
              }));
            }
          } catch (e) { console.error(e); }
        };
        poll();
        const interval = setInterval(poll, 3000);
        return () => clearInterval(interval);
      }, [roomId]);

      // AI timeout - add AI player if no one joins in 30 seconds
      useEffect(() => {
        if (!roomId || !room || room.phase !== 0 || aiAdded) return;
        if (room.creator.toLowerCase() !== wallet.address.toLowerCase()) return;
        if (players.length > 1) return; // Someone joined

        const timer = setTimeout(async () => {
          if (players.length === 1) {
            setSuccess('No players joined. Adding AI companion...');
            try {
              await writeContract(wallet.address, 'add_ai_player', [roomId]);
              setAiAdded(true);
              setSuccess('AI player added! You can start the game now.');
            } catch (e) { 
              setError('Failed to add AI: ' + e.message); 
            }
          }
        }, AI_TIMEOUT);

        setAiTimeout(timer);
        return () => clearTimeout(timer);
      }, [roomId, room, players, aiAdded, wallet.address]);

      // AI sends message after game starts (with delay)
      useEffect(() => {
        if (!roomId || !room || room.phase !== 1 || hasAISentMessage) return;
        if (room.creator.toLowerCase() !== wallet.address.toLowerCase()) return;
        
        const hasAI = players.some(p => isAI(p));
        if (!hasAI) return;

        const timer = setTimeout(async () => {
          const aiMsg = getAIDescription(room.artId);
          try {
            await writeContract(wallet.address, 'ai_send_msg', [roomId, aiMsg]);
            setHasAISentMessage(true);
          } catch (e) { console.error('AI message failed:', e); }
        }, 3000 + Math.random() * 5000); // 3-8 seconds delay

        return () => clearTimeout(timer);
      }, [roomId, room?.phase, players, hasAISentMessage]);

      // AI votes after voting starts (with delay)
      useEffect(() => {
        if (!roomId || !room || room.phase !== 2 || hasAIVoted) return;
        if (room.creator.toLowerCase() !== wallet.address.toLowerCase()) return;
        
        const hasAI = players.some(p => isAI(p));
        if (!hasAI) return;

        const timer = setTimeout(async () => {
          // AI votes for a random human player
          const humanPlayers = players.filter(p => !isAI(p));
          if (humanPlayers.length > 0) {
            const target = humanPlayers[Math.floor(Math.random() * humanPlayers.length)];
            try {
              await writeContract(wallet.address, 'ai_vote', [roomId, target]);
              setHasAIVoted(true);
            } catch (e) { console.error('AI vote failed:', e); }
          }
        }, 2000 + Math.random() * 3000); // 2-5 seconds delay

        return () => clearTimeout(timer);
      }, [roomId, room?.phase, players, hasAIVoted]);

      // Actions
      const createRoom = async () => {
        if (!wallet.connected) { await connect(); return; }
        setLoading(true);
        setAiAdded(false);
        setHasAISentMessage(false);
        setHasAIVoted(false);
        try {
          await writeContract(wallet.address, 'create_room', []);
          setSuccess('Creating room... Please wait.');
          setTimeout(async () => {
            const total = await readContract('get_count', []);
            const newRoomId = `r${total}`;
            setRoomId(newRoomId);
            setRoomCreateTime(Date.now());
            setTab('game');
            setSuccess('Room created: ' + newRoomId + '. Waiting for players (AI joins in 30s)');
          }, 5000);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const joinRoom = async (rid) => {
        if (!wallet.connected) { await connect(); return; }
        const targetRoom = rid || joinInput.trim();
        if (!targetRoom) { setError('Enter room ID'); return; }
        setLoading(true);
        setAiAdded(false);
        setHasAISentMessage(false);
        setHasAIVoted(false);
        try {
          await writeContract(wallet.address, 'join_room', [targetRoom]);
          setRoomId(targetRoom);
          setTab('game');
          setSuccess('Joined room: ' + targetRoom);
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const startGame = async () => {
        setLoading(true);
        try {
          await writeContract(wallet.address, 'start_game', [roomId]);
          setSuccess('Game started!');
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const sendMessage = async () => {
        if (!input.trim()) return;
        setLoading(true);
        try {
          await writeContract(wallet.address, 'send_msg', [roomId, input.trim()]);
          setInput('');
          setSuccess('Message sent!');
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const startVoting = async () => {
        setLoading(true);
        try {
          await writeContract(wallet.address, 'start_vote', [roomId]);
          setSuccess('Voting started!');
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const vote = async (target) => {
        setLoading(true);
        try {
          await writeContract(wallet.address, 'vote', [roomId, target]);
          setSuccess('Voted!');
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const finishGame = async () => {
        setLoading(true);
        try {
          await writeContract(wallet.address, 'finish', [roomId]);
          setSuccess('Game finished!');
        } catch (e) { setError(e.message); }
        setLoading(false);
      };

      const leaveRoom = () => { 
        setRoomId(''); 
        setRoom(null); 
        setPlayers([]);
        setMessages([]); 
        setTab('lobby'); 
        setRoomCreateTime(null);
        setAiAdded(false);
        setHasAISentMessage(false);
        setHasAIVoted(false);
        if (aiTimeout) clearTimeout(aiTimeout);
      };

      // Clear notifications
      useEffect(() => {
        if (error) setTimeout(() => setError(''), 4000);
        if (success) setTimeout(() => setSuccess(''), 3000);
      }, [error, success]);

      const phases = ['Waiting', 'Playing', 'Voting', 'Finished'];
      const art = room ? getArt(room.artId) : null;

      // Calculate time remaining for AI
      const getAICountdown = () => {
        if (!roomCreateTime || room?.phase !== 0 || players.length > 1) return null;
        const elapsed = Date.now() - roomCreateTime;
        const remaining = Math.max(0, Math.ceil((AI_TIMEOUT - elapsed) / 1000));
        return remaining > 0 ? remaining : null;
      };

      return (
        <div className="min-h-screen text-gray-200 p-4">
          {/* Notifications */}
          {error && <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 bg-red-500 rounded-lg fade-in">{error}</div>}
          {success && <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 bg-green-500 rounded-lg fade-in">{success}</div>}

          {/* Header */}
          <header className="max-w-4xl mx-auto flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold gradient-text">üé® Consensus Gallery</h1>
            {wallet.connected ? (
              <div className="flex items-center gap-2 px-3 py-2 glass rounded-lg">
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                <span className="text-sm">{shortAddr(wallet.address)}</span>
              </div>
            ) : (
              <button onClick={connect} className="btn-primary px-4 py-2 rounded-lg text-white font-medium">
                Connect Wallet
              </button>
            )}
          </header>

          {/* Nav */}
          <nav className="max-w-4xl mx-auto flex gap-2 mb-6">
            <button onClick={() => setTab('lobby')} className={`px-4 py-2 rounded-lg ${tab === 'lobby' ? 'bg-white/10' : ''}`}>üè† Lobby</button>
            <button onClick={() => setTab('game')} className={`px-4 py-2 rounded-lg ${tab === 'game' ? 'bg-white/10' : ''}`}>üéÆ Game</button>
          </nav>

          <main className="max-w-4xl mx-auto">
            {/* Lobby */}
            {tab === 'lobby' && (
              <div className="space-y-6 fade-in">
                <div className="glass rounded-xl p-6">
                  <h2 className="text-xl font-semibold mb-4">Create New Game</h2>
                  <button onClick={createRoom} disabled={loading} className="btn-primary w-full py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2">
                    {loading ? <Spinner /> : '‚ú® Create Room'}
                  </button>
                  <p className="text-xs text-gray-400 mt-2 text-center">If no one joins in 30 seconds, an AI player will join automatically</p>
                </div>

                {/* Waiting Rooms List */}
                <div className="glass rounded-xl p-6">
                  <h2 className="text-xl font-semibold mb-4">üö™ Open Rooms ({waitingRooms.length})</h2>
                  {waitingRooms.length === 0 ? (
                    <p className="text-gray-400 text-center py-4">No rooms waiting for players</p>
                  ) : (
                    <div className="space-y-2">
                      {waitingRooms.map(r => (
                        <div key={r.rid} className="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10">
                          <div>
                            <span className="font-medium">{r.rid}</span>
                            <span className="text-gray-400 text-sm ml-2">by {shortAddr(r.creator)}</span>
                            <span className="text-gray-400 text-sm ml-2">‚Ä¢ {r.playerCount}/5 players</span>
                          </div>
                          <button 
                            onClick={() => joinRoom(r.rid)} 
                            disabled={loading || r.creator.toLowerCase() === wallet.address.toLowerCase()}
                            className="btn-success px-4 py-2 rounded-lg text-white text-sm"
                          >
                            {r.creator.toLowerCase() === wallet.address.toLowerCase() ? 'Your Room' : 'Join'}
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="glass rounded-xl p-6">
                  <h2 className="text-xl font-semibold mb-4">Join by Room ID</h2>
                  <div className="flex gap-2">
                    <input 
                      value={joinInput} 
                      onChange={e => setJoinInput(e.target.value)} 
                      placeholder="Enter room ID (e.g., r1)" 
                      className="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-lg"
                    />
                    <button onClick={() => joinRoom()} disabled={loading} className="btn-success px-6 py-3 rounded-lg text-white font-medium">
                      {loading ? <Spinner /> : 'Join'}
                    </button>
                  </div>
                </div>

                <div className="glass rounded-xl p-6 text-center text-gray-400">
                  <p>Contract: <code className="text-xs bg-white/10 px-2 py-1 rounded">{shortAddr(CONTRACT_ADDRESS)}</code></p>
                  <p className="text-sm mt-2">‚õìÔ∏è All game data is stored on GenLayer blockchain</p>
                </div>
              </div>
            )}

            {/* Game */}
            {tab === 'game' && (
              <div className="fade-in">
                {!roomId ? (
                  <div className="glass rounded-xl p-8 text-center">
                    <p className="text-gray-400 mb-4">No active game. Create or join a room first!</p>
                    <button onClick={() => setTab('lobby')} className="btn-primary px-6 py-2 rounded-lg text-white">Go to Lobby</button>
                  </div>
                ) : (
                  <div className="grid md:grid-cols-2 gap-6">
                    {/* Left: Art & Info */}
                    <div className="space-y-4">
                      <div className="glass rounded-xl p-4">
                        <div className="flex justify-between items-center mb-3">
                          <span className="font-medium">Room: {roomId}</span>
                          <span className={`px-2 py-1 rounded text-sm ${room?.phase === 0 ? 'bg-gray-500/30' : room?.phase === 1 ? 'bg-green-500/30' : room?.phase === 2 ? 'bg-yellow-500/30' : 'bg-purple-500/30'}`}>
                            {room ? phases[room.phase] : 'Loading...'}
                          </span>
                        </div>
                        {art && (
                          <div>
                            <img src={art.url} alt={art.name} className="w-full h-64 object-cover rounded-lg mb-2" />
                            <p className="text-center text-sm text-gray-400">{art.name}</p>
                          </div>
                        )}
                      </div>

                      {/* Players */}
                      <div className="glass rounded-xl p-4">
                        <h3 className="font-medium mb-2">üë• Players ({players.length})</h3>
                        {players.map((p, i) => (
                          <div key={i} className={`p-2 rounded mb-1 flex items-center justify-between ${
                            isAI(p) ? 'bg-blue-500/20' : 
                            p.toLowerCase() === wallet.address.toLowerCase() ? 'bg-purple-500/20' : 'bg-white/5'
                          }`}>
                            <span>
                              {shortAddr(p)} 
                              {p.toLowerCase() === room?.creator?.toLowerCase() && ' üëë'} 
                              {p.toLowerCase() === wallet.address.toLowerCase() && ' (You)'}
                            </span>
                            {isAI(p) && <span className="text-xs text-blue-400">AI</span>}
                          </div>
                        ))}
                        
                        {/* AI Countdown */}
                        {room?.phase === 0 && room?.creator?.toLowerCase() === wallet.address.toLowerCase() && players.length === 1 && (
                          <div className="mt-2 p-2 bg-blue-500/10 rounded text-center">
                            <p className="text-sm text-blue-300 animate-pulse">
                              ü§ñ AI joins in {getAICountdown() || '...'} seconds
                            </p>
                          </div>
                        )}
                      </div>

                      {/* Actions */}
                      <div className="space-y-2">
                        {room?.phase === 0 && room?.creator?.toLowerCase() === wallet.address.toLowerCase() && (
                          <button onClick={startGame} disabled={loading || players.length < 2} className="btn-success w-full py-3 rounded-lg text-white">
                            {loading ? <Spinner /> : `Start Game (${players.length}/2+ players)`}
                          </button>
                        )}
                        {room?.phase === 1 && (
                          <button onClick={startVoting} disabled={loading} className="bg-yellow-500 w-full py-3 rounded-lg text-black font-medium">
                            {loading ? <Spinner /> : 'End Game & Start Voting'}
                          </button>
                        )}
                        {room?.phase === 2 && (
                          <button onClick={finishGame} disabled={loading} className="bg-purple-500 w-full py-3 rounded-lg text-white">
                            {loading ? <Spinner /> : 'Finalize Results'}
                          </button>
                        )}
                        <button onClick={leaveRoom} className="w-full py-2 text-gray-400 hover:text-white">‚Üê Leave Room</button>
                      </div>
                    </div>

                    {/* Right: Chat & Voting */}
                    <div className="space-y-4">
                      {/* Messages */}
                      <div className="glass rounded-xl p-4">
                        <h3 className="font-medium mb-2">üí¨ Descriptions</h3>
                        <div className="h-64 overflow-y-auto space-y-2 mb-3">
                          {messages.length === 0 ? (
                            <p className="text-gray-500 text-center py-8">No messages yet</p>
                          ) : (
                            messages.map((m, i) => (
                              <div key={i} className={`p-3 rounded-lg ${
                                isAI(m.author) ? 'bg-blue-500/20 mr-4' :
                                m.author.toLowerCase() === wallet.address.toLowerCase() ? 'bg-purple-500/20 ml-4' : 'bg-white/5 mr-4'
                              }`}>
                                <div className="text-xs text-gray-400 mb-1">
                                  {shortAddr(m.author)}
                                  {isAI(m.author) && ' ü§ñ'}
                                </div>
                                <p className="text-sm">{m.content}</p>
                              </div>
                            ))
                          )}
                        </div>
                        {room?.phase === 1 && (
                          <div className="flex gap-2">
                            <input
                              value={input}
                              onChange={e => setInput(e.target.value)}
                              onKeyPress={e => e.key === 'Enter' && sendMessage()}
                              placeholder="Describe the artwork..."
                              className="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm"
                            />
                            <button onClick={sendMessage} disabled={loading} className="btn-primary px-4 py-2 rounded-lg text-white">
                              {loading ? <Spinner /> : 'Send'}
                            </button>
                          </div>
                        )}
                      </div>

                      {/* Voting */}
                      {room?.phase === 2 && (
                        <div className="glass rounded-xl p-4">
                          <h3 className="font-medium mb-3">üó≥Ô∏è Vote for Best Description</h3>
                          {[...new Set(messages.map(m => m.author))].map(addr => (
                            <button key={addr} onClick={() => vote(addr)} disabled={loading} className="w-full p-3 mb-2 bg-white/5 rounded-lg text-left hover:bg-white/10">
                              <div className="font-medium">
                                {shortAddr(addr)}
                                {isAI(addr) && ' ü§ñ'}
                              </div>
                              <div className="text-sm text-gray-400 truncate">
                                {messages.find(m => m.author === addr)?.content}
                              </div>
                            </button>
                          ))}
                        </div>
                      )}

                      {/* Winner */}
                      {room?.phase === 3 && room?.winner && (
                        <div className="glass rounded-xl p-6 text-center">
                          <div className="text-4xl mb-2">üèÜ</div>
                          <h3 className="text-xl font-bold mb-2">Winner!</h3>
                          <p className="text-purple-400">
                            {shortAddr(room.winner)}
                            {isAI(room.winner) && ' ü§ñ'}
                          </p>
                          {room.winner.toLowerCase() === wallet.address.toLowerCase() && (
                            <p className="text-green-400 mt-2">Congratulations! +100 XP</p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>

          <footer className="max-w-4xl mx-auto text-center py-8 text-gray-500 text-sm">
            Powered by <a href="https://genlayer.com" className="text-purple-400">GenLayer</a>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
